import{e as o,y as h,c as d,u as x,a as m,g,bd as P}from"./index-Bv0Hohk0.js";import{N as v}from"./DynamicLayerView3D-BkWtl3DK.js";import{j as I}from"./commonProperties-71l2LJ6s.js";import{a as F}from"./ExportWMSImageParameters-oP84eWiR.js";import"./LayerView3D-BHAdUlxy.js";import"./projectExtentUtils-jytcdcl1.js";import"./ImageMaterial.glsl-B_fxTFoc.js";import"./LayerView-xIua26SL.js";import"./RefreshableLayerView-ByEXgiMo.js";const b=r=>{let e=class extends r{initialize(){this.exportImageParameters=new F({layer:this.layer})}destroy(){this.exportImageParameters=x(this.exportImageParameters)}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeaturesAtLocation(t,i){const{layer:a}=this;if(!t)throw new m("wmslayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:a});const{popupEnabled:n}=a;if(!n)throw new m("wmslayerview:fetchPopupFeatures","popupEnabled should be true",{popupEnabled:n});const p=this.createFetchPopupFeaturesQuery(t);if(!p)return[];const{extent:s,width:u,height:c,x:y,y:w}=p;if(!(s&&u&&c))throw new m("wmslayerview:fetchPopupFeatures","WMSLayer does not support fetching features.",{extent:s,width:u,height:c});const f=await a.fetchFeatureInfo(s,u,c,y,w);return g(i),f}};return o([h()],e.prototype,"exportImageParameters",void 0),o([h({readOnly:!0})],e.prototype,"exportImageVersion",null),o([h()],e.prototype,"layer",void 0),o([h(I)],e.prototype,"timeExtent",void 0),e=o([d("esri.layers.mixins.WMSLayerView")],e),e};let l=class extends b(v){constructor(){super(...arguments),this.type="wms-3d"}initialize(){this.layer.serviceSupportsSpatialReference(this.view.spatialReference)||this.addResolvingPromise(Promise.reject(new m("layerview:spatial-reference-incompatible","The spatial references supported by this WMS layer are incompatible with the spatial reference of the view"))),this._updatingHandles.add(()=>{var r;return(r=this.exportImageParameters)==null?void 0:r.version},()=>{this._updatingHandles.addPromise(this.refreshDebounced())})}createFetchPopupFeaturesQuery(r){const e=this.findExtentInfoAt(r),t=e.extent,i=new P(t[0],t[1],t[2],t[3],this._spatialReference),a=e.imageSize,n=a.width,p=a.height,s=i.width/n;return{extent:i,width:n,height:p,x:Math.round((r.x-i.xmin)/s),y:Math.round((i.ymax-r.y)/s)}}getFetchOptions(){return{timeExtent:this.timeExtent}}};l=o([d("esri.views.3d.layers.WMSLayerView3D")],l);const $=l;export{$ as default};
