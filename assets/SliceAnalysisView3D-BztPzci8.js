import{bF as Qt,bp as ei,io as ti,e as h,y as p,ba as Dt,eW as it,gZ as at,g_ as st,c as ce,cb as ue,mq as Ot,E as ii,gI as be,sK as ai,sL as si,a0 as Ve,sN as nt,tR as rt,sR as ni,sV as ri,_ as li,sY as oi,sZ as ui,tz as ci,s_ as di,tS as hi,qt as pe,it as pi,t4 as gi,tn as _i,ta as vi,ir as wi,sS as yi,un as mi,tg as fi,te as Pi,tT as bi,k7 as C,ke as lt,g3 as Vi,ms as $e,kQ as St,ki as o,lK as _,e$ as I,uo as It,nx as R,d2 as N,d3 as A,eZ as y,gy as T,eY as k,up as He,o_ as Rt,uj as x,uq as Mi,ur as Ge,us as Ti,ut as Ei,hj as xt,d4 as J,uu as We,kj as At,o5 as K,uv as kt,nF as $i,k1 as Ci,iy as Lt,d$ as Di,uw as Oi,lm as b,ux as Ne,r5 as ot,uy as Me,uz as Si,q as me,h5 as Ii,S as qe,l as ut,A as M,k6 as oe,P as Ke,aj as U,kh as W,ra as E,eX as z,r9 as Ri,mp as Ht,$ as xi,a1 as ct,kf as ge,iU as _e,d5 as Z,rc as dt,j2 as ht,fj as Se,fi as pt,uA as gt,uB as _t,uC as vt,uD as Ai,rP as ki,ly as Li,B as Hi,J as Ue,u as Q,mu as se,uE as P,uF as ne,o$ as wt,oW as ze,kV as fe,p3 as Ie,r6 as Gi,e_ as yt,hl as Ni,iQ as mt,kR as Ui,kT as zi,uG as Gt,k9 as ji,rS as Nt,rM as Fi}from"./index-Bv0Hohk0.js";import{b as Bi,f as Wi,r as qi,a as Ki,s as Zi}from"./LineVisualElement-BA2FWRBH.js";import{j as re}from"./persistable-CqahfBmp.js";import{_ as Xi}from"./BuildingComponentSublayer-D20R9pYM.js";import{w as Yi,e as Ze,j as Ji,a as V,h as Ut,o as Qi,x as ve,c as ea,b as ta,v as ia}from"./ShadedColorMaterial.glsl-Cak3Vz2U.js";import{t as aa,l as sa,n as na,O as we}from"./ToolIntersector-DHrjlBzv.js";import{T as ra}from"./ImageMaterial.glsl-B_fxTFoc.js";import"./MD5-C9MwAd2G.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./resourceExtension-DX05oFmI.js";import"./UniqueValueRenderer-C8B84zcF.js";import"./diffUtils-D_LMLEpD.js";import"./jsonUtils-CvVppPa6.js";import"./FieldsIndex-j25pkYvJ.js";import"./UnknownTimeZone-81r46adS.js";import"./heatmapUtils-CpfvS1IE.js";import"./FeatureLayer-Bl4Oa2Ns.js";import"./MultiOriginJSONSupport-BZQTWpeF.js";import"./FormTemplate-FSyxNdA8.js";import"./editsZScale-BIAQdbBN.js";import"./queryZScale-DalU9HM9.js";import"./FeatureSet-DZOCMyA1.js";import"./APIKeyMixin-0dcGhBjP.js";import"./ArcGISService-uQPwYVuT.js";import"./CustomParametersMixin-DKqLR8tC.js";import"./EditBusLayer-CAsf3J8a.js";import"./FeatureEffectLayer-xcthoMRe.js";import"./FeatureEffect-DsB_OIRS.js";import"./FeatureFilter-x-ktONiu.js";import"./FeatureLayerBase-DdVIldVS.js";import"./commonProperties-71l2LJ6s.js";import"./featureLayerUtils-pwhGpgI4.js";import"./featureQueryAll-Dvpwrv0X.js";import"./AttachmentQuery-B5Jh59Bx.js";import"./RelationshipQuery-QRZ1tsX4.js";import"./LayerFloorInfo-D_j1_8Sf.js";import"./serviceCapabilitiesUtils-JAuO7eFe.js";import"./FeatureReductionLayer-CENesjyy.js";import"./FeatureReductionSelection-CsTr2Kpw.js";import"./LabelClass-DPzxJqvN.js";import"./OperationalLayer-CgleBBYh.js";import"./OrderedLayer-CeeaGzzr.js";import"./PortalLayer-DaNsTDLt.js";import"./portalItemUtils-JWUEQXnE.js";import"./TemporalLayer-C1KR7WBT.js";import"./TimeInfo-Cqort3EX.js";import"./FeatureTemplate-BU0tvyV1.js";import"./FeatureType-BD0awc-y.js";import"./fieldProperties-QeW_-2Ss.js";import"./labelingInfo-B67D2ZxN.js";import"./versionUtils-C_5-kApp.js";import"./styleUtils-B6WLKgkA.js";import"./TopFeaturesQuery-DK9IN5Vy.js";import"./popupUtils-Cu5Z_JS9.js";import"./interfaces-CL2NbQte.js";import"./capabilities-CVH7PnKh.js";import"./I3SIndexInfo-C9hHhxPX.js";import"./I3SLayerDefinitions-mJYKJt0E.js";import"./I3SUtil-CS_iMtLE.js";import"./I3SBinaryReader-DZo_O6Xi.js";import"./popupUtils-D-6l6-mq.js";let L=class extends Qt(ei){constructor(t){super(t),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(t){return this.heading===t.heading&&this.tilt===t.tilt&&ti(this.position,t.position)&&this.width===t.width&&this.height===t.height}};h([p({readOnly:!0,json:{read:!1,write:!0}})],L.prototype,"type",void 0),h([p({type:Dt}),re()],L.prototype,"position",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:360}}),re(),it(e=>at.normalize(st(e),0,!0))],L.prototype,"heading",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:360}}),re(),it(e=>at.normalize(st(e),0,!0))],L.prototype,"tilt",void 0),h([p({type:Number,nonNullable:!0}),re()],L.prototype,"width",void 0),h([p({type:Number,nonNullable:!0}),re()],L.prototype,"height",void 0),L=h([ce("esri.analysis.SlicePlane")],L);const Xe=L,Ye=ue(0,0,0,.04);function zt({accentColor:e}){return Ot(e,.5)}function Je({accentColor:e}){return Ot(e,.7)}const Re=ii("mac")?"Meta":"Control",xe="Shift",la=2,oa=1.15,ua=1.15,ca=2500,da=.02,ha=Math.cos(be(45)),ft=Math.cos(be(5)),pa=.95,ga=.3,jt=2,Ft=1,_a=3,Bt=11,je=22.5,Pe=40,Pt=48,va=2.25,wa=4,bt=1,ya=.3,ma=6,fa=4,Vt=1600,Pa=.4;function Wt(e){const t=new ai,{vertex:i,fragment:a,attributes:s,varyings:n}=t;return si(i,e),s.add(Ve.POSITION,"vec3"),s.add(Ve.UV0,"vec2"),n.add("vUV","vec2"),i.code.add(nt`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),a.uniforms.add(new rt("backgroundColor",r=>r.backgroundColor),new rt("gridColor",r=>r.gridColor),new ni("gridWidth",r=>r.gridWidth)),a.code.add(nt`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
fragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),t}const ba=Object.freeze(Object.defineProperty({__proto__:null,build:Wt},Symbol.toStringTag,{value:"Module"}));let Va=class extends _i{constructor(){super(...arguments),this.backgroundColor=ue(1,0,0,.5),this.gridColor=ue(0,1,0,.5),this.gridWidth=4}};class Ce extends oi{initializeProgram(t){return new ui(t.rctx,Ce.shader.get().build(this.configuration),ci)}initializePipeline(){return di({blending:hi(pe.ONE,pe.ONE,pe.ONE_MINUS_SRC_ALPHA,pe.ONE_MINUS_SRC_ALPHA),depthTest:{func:pi.LESS},colorWrite:gi})}}Ce.shader=new ri(ba,()=>li(()=>Promise.resolve().then(()=>as),void 0));let Ma=class extends vi{constructor(t){super(t,new Ea),this.produces=new Map([[wi.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,i=>i===yi.Color]]),this._configuration=new mi}createBufferWriter(){return new fi(Pi)}createGLMaterial(t){return new Ta(t)}getConfiguration(){return this._configuration}},Ta=class extends bi{constructor(t){super(t),this.ensureTechnique(Ce,null)}beginSlot(){return this.technique}},Ea=class extends Va{constructor(){super(...arguments),this.renderOccluded=C.Occlude,this.isDecoration=!1}};class $a extends Bi{constructor(t){super(t),this._material=null,this._renderOccluded=C.OccludeAndTransparent,this._gridWidth=1,this._gridColor=ue(1,0,0,1),this._backgroundColor=ue(1,0,0,1),this.applyProperties(t)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(t){this._gridWidth!==t&&(this._gridWidth=t,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(t){lt(this._gridColor,t),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(t){lt(this._backgroundColor,t),this._updateMaterial()}createExternalResources(){this._material=new Ma(this._materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(t){this._material!=null&&t(this._material)}createGeometries(t){if(this._material!=null){const i=Vi(this._material);t.addGeometry(i)}}get _materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateMaterial(){this._material!=null&&this._material.setParameters(this._materialParameters)}}function Ca(e,t,i,a,s,n,r,l){return Da(t,r.worldUpAtPosition(e,o.get()),s,n,l.basis1,l.basis2),_(l.basis1,l.basis1,i),_(l.basis2,l.basis2,a),I(l.origin,e),It(l.basis2,l.basis1,l.origin,l.plane),l}function Da(e,t,i,a,s,n){const r=R(e,t),l=o.get(),u=o.get();switch(a===$.HORIZONTAL_OR_VERTICAL?Math.abs(r)>ha?$.HORIZONTAL:$.VERTICAL:a){case $.VERTICAL:{const d=Math.abs(r)<=ft?e:i.viewUp;N(l,d,t),I(u,t);break}case $.HORIZONTAL:N(l,i.viewUp,t),N(u,t,l);break;case $.TILTED:{const d=Math.abs(r)<=ft?t:i.viewUp;N(l,d,e),N(u,e,l);break}}const c=N(o.get(),l,u);R(c,i.viewForward)>0&&_(u,u,-1),A(s,l),A(n,u)}function Oa(e,t,i){const a=t.worldUpAtPosition(e.origin,o.get()),s=e.basis1,n=tt(e,a),r=Math.round(n/te)*te;return Ne(e,r-n,s,i)}function Sa(e,t,i,a,s,n){const r=I(o.get(),s.origin);y(r,r,_(o.get(),s.basis1,e.direction[0]<0?1:-1)),y(r,r,_(o.get(),s.basis2,e.direction[1]<0?1:-1));const l=T(s.basis1),u=T(s.basis2),c=k(o.get(),i,r),d=k(o.get(),t,r);let g=0,v=0;if(et(e)){const De=Fe(s),ie=Fe(n);g=l-.5*e.direction[0]*R(s.basis1,d)/l,v=u-.5*e.direction[1]*R(s.basis2,d)/u;const de=ie/De;g*=de,v*=de}const m=g+.5*e.direction[0]*R(s.basis1,c)/l,O=v+.5*e.direction[1]*R(s.basis2,c)/u,X=_(o.get(),s.basis1,m/l),j=_(o.get(),s.basis2,O/u);(m<=0||Tt(n.origin,X,a)<=Vt)&&I(X,n.basis1),(O<=0||Tt(n.origin,j,a)<=Vt)&&I(j,n.basis2);const D=I(o.get(),r);return y(D,D,_(o.get(),X,e.direction[0]<0?-1:1)),y(D,D,_(o.get(),j,e.direction[1]<0?-1:1)),He(D,X,j,n)}function Ia(e,t){return Pa*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function Ra(e,t,i,a){const s=N(o.get(),t,i);return N(s,s,t),Rt(e,s,a)}function qt(e,t){return Yi(e.basis1,e.basis2,e.origin,t)}function Mt(e,t,i,a){const s=t.worldUpAtPosition(e.origin,o.get()),n=o.get();switch(i){case ee.HEADING:I(n,s);break;case ee.TILT:I(n,e.basis1)}return Rt(e.origin,n,a)}function xa(e,t,i,a){const s=Qe(i,H.NEGATIVE_X),n=x.get();Mi(n,t,s.edge*Math.PI/2);const r=A(o.get(),s.basis);let l=_(o.get(),r,s.direction*a.computeScreenPixelSizeAt(s.position)*Pe);y(l,l,s.position);const u=a.projectToRenderScreen(l,Ge(o.get())),c=Aa(a,u);Ti(a,u,ye),A(ye.direction,ye.direction);const d=o.get();!c&&Ei(i,ye,d)&&(l=d),n[12]=0,n[13]=0,n[14]=0,e.modelTransform=n,e.renderLocation=xt(l),c?e.state|=Te:e.state&=~Te}function Aa(e,t){const[i,a,s,n]=e.viewport,r=Math.min(s,n)/16;let l=!0;return t[0]<i+r?(t[0]=i+r,l=!1):t[0]>i+s-r&&(t[0]=i+s-r,l=!1),t[1]<a+r?(t[1]=a+r,l=!1):t[1]>a+n-r&&(t[1]=a+n-r,l=!1),l}function ka(e,t,i,a){const s=T(a.basis1),n=T(a.basis2),r=Kt(a),l=Fe(a),u=J(o.get(),0,0,0);y(u,_(o.get(),a.basis1,t.direction[0]),_(o.get(),a.basis2,t.direction[1])),y(u,a.origin,u);let c=0,d=1;if(et(t))t.direction[0]===1&&t.direction[1]===-1?c=te:t.direction[0]===1&&t.direction[1]===1?c=Math.PI:t.direction[0]===-1&&t.direction[1]===1&&(c=3*Math.PI/2),d=l;else{const v=t.direction[0]!==0?1:2;c=v===1?te:0,d=(v===1?n:s)-r}const g=We(x.get(),c);At(g,g,J(o.get(),d,d,d)),K(g,i,g),g[12]=0,g[13]=0,g[14]=0,e.modelTransform=g,e.renderLocation=u}function La(e,t,i,a){const s=a.worldUpAtPosition(i.origin,o.get()),n=Qe(i,H.POSITIVE_X),r=We(x.get(),n.edge*Math.PI/2);kt(r,r,-tt(i,s)),K(r,t,r),r[12]=0,r[13]=0,r[14]=0,e.modelTransform=r,e.renderLocation=n.position}function Ha(e,t,i){const a=Qe(i,H.POSITIVE_Y),s=We(x.get(),a.edge*Math.PI/2);kt(s,s,te),K(s,t,s),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=a.position}var H;function Qe(e,t){switch(t){case H.POSITIVE_X:return{basis:e.basis1,direction:1,position:y(o.get(),e.origin,e.basis1),edge:t};case H.POSITIVE_Y:return{basis:e.basis2,direction:1,position:y(o.get(),e.origin,e.basis2),edge:t};case H.NEGATIVE_X:return{basis:e.basis1,direction:-1,position:k(o.get(),e.origin,e.basis1),edge:t};case H.NEGATIVE_Y:return{basis:e.basis2,direction:-1,position:k(o.get(),e.origin,e.basis2),edge:t}}}function Tt(e,t,i){const a=i.projectToRenderScreen(y(o.get(),e,t),Ge(o.get())),s=i.projectToRenderScreen(k(o.get(),e,t),Ge(o.get()));return $i(k(a,a,s))}function Kt(e){const t=T(e.basis1),i=T(e.basis2);return ya*Math.min(t,i)}function Fe(e){return Kt(e)}function et(e){return e.direction[0]!==0&&e.direction[1]!==0}function Zt(e){const t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]];return new Wi({view:e,attached:!1,color:Je(e.effectiveTheme),width:Ft,renderOccluded:C.OccludeAndTransparent,geometry:[t],isDecoration:!0})}function Xt(e){return new $a({view:e,attached:!1,backgroundColor:Ye,gridColor:zt(e.effectiveTheme),gridWidth:4,renderOccluded:C.OccludeAndTransparent,isDecoration:!0})}function Yt(e,t,i,a=new Xe){if(e==null)return null;const{renderCoordsHelper:s}=t,n=s.fromRenderCoords(e.origin,new Dt({spatialReference:t.spatialReference}));if(n==null)return null;const r=Ci(n,i);if(r==null)return null;a.position=r;const l=2*T(e.basis1),u=2*T(e.basis2),c=Lt.renderUnitScaleFactor(t.spatialReference,i);a.width=l*c,a.height=u*c;const d=s.worldUpAtPosition(e.origin,o.get());return a.tilt=Di(tt(e,d)),a.heading=s.headingAtPosition(e.origin,e.basis1)-90,a}function tt(e,t){return Oi(t,e.basis2,e.basis1)+te}function Ga(e,t,i,a,s,n,r=b()){return n.toRenderCoords(e,r.origin)?(n.worldBasisAtPosition(r.origin,ot.X,r.basis1),n.worldBasisAtPosition(r.origin,ot.Y,r.basis2),It(r.basis2,r.basis1,r.origin,r.plane),Ne(r,-be(t),Me(r),r),Ne(r,be(i),r.basis1,r),_(r.basis1,r.basis1,a/2),_(r.basis2,r.basis2,s/2),Si(r),r):(me.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}function Na(e,t){if((e==null?void 0:e.position)==null)return null;const i=qi(e.position,t.spatialReference,t.elevationProvider);if(i==null)return null;const a=Lt.renderUnitScaleFactor(e.position.spatialReference,t.spatialReference),s=e.width*a,n=e.height*a;return{position:i,heading:e.heading,tilt:e.tilt,renderWidth:s,renderHeight:n}}function Ua(e,t,i,a=b()){if(e==null)return null;const s=Ga(e.position,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,a);return i.tiltEnabled||s==null||Oa(s,t.renderCoordsHelper,s),s}(function(e){e[e.POSITIVE_X=0]="POSITIVE_X",e[e.POSITIVE_Y=1]="POSITIVE_Y",e[e.NEGATIVE_X=2]="NEGATIVE_X",e[e.NEGATIVE_Y=3]="NEGATIVE_Y"})(H||(H={}));const f=$e.Custom1;var ee,$;(function(e){e[e.HEADING=1]="HEADING",e[e.TILT=2]="TILT"})(ee||(ee={})),function(e){e[e.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.TILTED=3]="TILTED"}($||($={}));const Te=$e.Custom2,ye=St(),te=Math.PI/2,Ae=$e.Custom1,za=$e.Custom2;function ja(e){return(e.type==="building-scene-3d"?e:null)!=null}function Fa(e){switch(e.type){case"building-scene":case"catalog":case"catalog-dynamic-group":case"catalog-footprint":case"csv":case"dimension":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"integrated-mesh-3dtiles":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"video":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return Ii(e.type),!1}}let B=class extends qe{constructor(t){super(t),this._internalChange=!1,this._currentSlicePlane=null}initialize(){this.addHandles(this.analysis.excludedLayers.on("before-add",t=>{const i=t.item;i!=null&&(i instanceof ut||i instanceof Xi)?i instanceof ut&&Fa(i)?(me.getLogger(this).error("excludedLayers",`Layer '${i.title}, id:${i.id}' of type '${i.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),t.preventDefault()):this.analysis.excludedLayers.includes(i)&&t.preventDefault():(me.getLogger(this).error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),t.preventDefault())})),Wa(this.view,this),this.addHandles([M(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),M(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),M(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),M(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this.addHandles([M(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null,this._updateActiveController(),this._updateViewSlicePlane()),qa(this.view,this),this.set("view",null)}get _allLayerAndSubLayerViews(){const t=this.view.allLayerViews.items;return t.concat(t.filter(ja).flatMap(({sublayerViews:i})=>i.items))}_updateBoundedPlaneFromSlicePlane(){const t=this.analysis.shape,i=this._currentSlicePlane;if(i==null&&t==null||i!=null&&t!=null&&t.equals(i))return;let a=null,s=null;if((t==null?void 0:t.position)!=null){const n=t.position.spatialReference,r=Na(t,this.view);r==null&&Ki(this.analysis,n,me.getLogger(this)),a=Ua(r,this.view,{tiltEnabled:this.analysis.tiltEnabled},b()),a!=null&&(s={heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height})}this._currentSlicePlane=s,this._internalChange=!0,this.analysisViewData.plane=a,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const t=this.analysisViewData.plane,i=Yt(t,this.view,this.view.spatialReference,new Xe);let a=null;i!=null&&(a={heading:i.heading,tilt:i.tilt,position:i.position,width:i.width,height:i.height}),this._currentSlicePlane=a,this._internalChange=!0,this.analysis.shape=i,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(ke)return;const t=Jt(this.view);if(t)if(this.analysisViewData.active)t.activeController!=null&&t.activeController!==this?(ke=!0,t.activeController.analysisViewData.active=!1,ke=!1):t.activeController!=null&&t.activeController,this._updateLayerViews(),t.activeController=this;else{if(t.activeController!=null&&t.activeController!==this)return;t.activeController!=null&&t.activeController===this&&(t.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){Ba(this.view)}_updateLayerViews(){const t=this.analysisViewData.plane!=null&&this.analysisViewData.visible&&this.analysisViewData.active,i=[],a=s=>{"layers"in s?s.layers.forEach(a):i.push(s)};this.analysis.excludedLayers.forEach(a),this.view.allLayerViews.forEach(s=>{s.destroyed||("slicePlaneEnabled"in s&&(s.slicePlaneEnabled=t&&!i.includes(s.layer)),"sublayerViews"in s&&s.sublayerViews.forEach(n=>{n.slicePlaneEnabled=t&&!i.includes(n.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=t&&!this.analysis.excludeGroundSurface)}};h([p()],B.prototype,"view",void 0),h([p()],B.prototype,"analysis",void 0),h([p()],B.prototype,"analysisViewData",void 0),h([p()],B.prototype,"_allLayerAndSubLayerViews",null),B=h([ce("esri.views.3d.analysis.Slice.SliceController")],B);const q=new Map;let ke=!1;function Ba(e){const t=Jt(e),i=t==null?void 0:t.activeController;(i==null?void 0:i.analysisViewData.plane)!=null&&i.analysisViewData.visible?e.slicePlane=i.analysisViewData.plane:e.slicePlane=null}function Wa(e,t){var i;q.has(e)||q.set(e,{all:[],activeController:null}),(i=q.get(e))==null||i.all.push(t)}function Jt(e){return q.get(e)}function qa(e,t){if(!q.has(e))throw new Error("view expected in global slice register");const i=q.get(e),a=(i==null?void 0:i.all.lastIndexOf(t))??-1;if(!i||a===-1)throw new Error("controller expected in global slice register");i.all.splice(a,1),i.all.length===0&&q.delete(e)}class Ka extends Ze{constructor(t,i){const a=et(i),s=a?wa:bt,n=s*la,r=bt,l={renderOccluded:C.OccludeAndTransparent,isDecoration:!0},u=new oe({...l,width:s}),c=new oe({...l,width:n}),d=new oe({...l,width:r});super({view:t,...Ji,...Za({isCorner:a,unfocusedMaterial:u,focusedMaterial:c,outlineMaterial:d})}),this._themeHandle=M(()=>t.effectiveTheme.accentColor,g=>{const v=U.toUnitRGBA(g);u.setParameters({color:v}),c.setParameters({color:v}),d.setParameters({color:v})},Ke)}destroy(){this._themeHandle.remove(),super.destroy()}}function Za({isCorner:e,unfocusedMaterial:t,focusedMaterial:i,outlineMaterial:a}){const s=e?[z(1,0,0),z(0,0,0),z(0,1,0)]:[z(1,0,0),z(-1,0,0)];return{renderObjects:[new V(W(t,s),E.Unfocused|Ae),new V(W(i,s),E.Focused|Ae),new V(W(a,s),za)],collisionType:{type:"line",paths:[s]},radius:e?ma:fa,state:Ae}}class Et extends Ze{constructor(t,i){const a=new ra({transparent:!0,writeDepth:!1,renderOccluded:C.Opaque,isDecoration:!0}),s=Ut.calloutWidth,n=new oe({width:s,renderOccluded:C.OccludeAndTransparent,isDecoration:!0});super({view:t,...Xa({imageMaterial:a,calloutMaterial:n})}),this._currentTexture=null,this._themeHandle=M(()=>t.effectiveTheme.accentColor,r=>{const l=Ri(r,.5),u=Ht(r),c=this._currentTexture,d=i(l,u);a.setParameters({textureId:d.texture.id}),n.setParameters({color:U.toUnitRGBA(r)}),this._currentTexture=d,c==null||c.release()},Ke)}destroy(){var t;this._themeHandle.remove(),(t=this._currentTexture)==null||t.release(),super.destroy()}}function Xa({imageMaterial:e,calloutMaterial:t}){const{focusMultiplier:i,calloutLength:a,discRadius:s}=Ut,n=s*i,r=(d,g)=>{const v=[0,1,2,2,3,0];return new xi(g,[[Ve.POSITION,new ct([a-d,-d,0,a+d,-d,0,a+d,d,0,a-d,d,0],v,3,!0)],[Ve.UV0,new ct([0,0,1,0,1,1,0,1],v,2,!0)]])},l=W(t,[[0,0,0],[a-s,0,0]]),u=W(t,[[0,0,0],[a-n,0,0]]),c=f;return{autoScaleRenderObjects:!1,collisionPriority:1,collisionType:{type:"disc",direction:[0,0,1],offset:[a,0,0]},focusMultiplier:i,radius:s,renderObjects:[new V(r(s,e),E.Unfocused|c),new V(l,E.Unfocused|c),new V(r(n,e),E.Focused|c),new V(u,E.Focused|c)],state:c}}var Ee;(function(e){e[e.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",e[e.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"})(Ee||(Ee={}));class Ya extends Ze{constructor(t,i){const a=new oe({width:1,renderOccluded:C.OccludeAndTransparent,isDecoration:!0}),s=new ge({cullFace:_e.Back,renderOccluded:C.Opaque,isDecoration:!0}),n=new ge({cullFace:_e.Back,renderOccluded:C.Opaque,isDecoration:!0}),r=new ge({cullFace:_e.Back,renderOccluded:C.Opaque,isDecoration:!0}),l=new ge({writeDepth:!1,cullFace:_e.Front,renderOccluded:C.Transparent,isDecoration:!0});super({view:t,...Ja({offsetMode:i,tubeMaterial:s,tipMaterial:n,capMaterial:r,outlineMaterial:l,calloutMaterial:a})}),this._themeHandle=M(()=>t.effectiveTheme.accentColor,u=>{const c=Ht(u),d=U.toUnitRGBA(u),g=U.toUnitRGBA(c),v=U.toUnitRGBA(U.blendColors(c,u,.4)),m=U.toUnitRGBA(U.blendColors(c,u,.14));a.setParameters({color:d}),s.setParameters({color:m}),n.setParameters({color:g}),r.setParameters({color:v}),l.setParameters({color:d})},Ke)}destroy(){this._themeHandle.remove(),super.destroy()}}function Ja({offsetMode:e,tubeMaterial:t,tipMaterial:i,capMaterial:a,outlineMaterial:s,calloutMaterial:n}){const r=e===Ee.CENTER_ON_CALLOUT?Pe:0,l=[z(r,0,-Pt/2),z(r,0,Pt/2)],u=es(l,!0),c=$t({vertices:l,padding:0,materials:{tube:t,tip:i,cap:a}}),d=$t({vertices:l,padding:va,materials:{tube:s,tip:s,cap:s}}),g=W(n,[[r,0,0],[r-Pe,0,0]]),v=W(n,[[r,0,0],[r-Pe,0,0]]);return{renderObjects:[...c.normal.map(m=>new V(m,E.Unfocused|f)),...d.normal.map(m=>new V(m,E.Unfocused|f)),new V(g,E.Unfocused|f|Te),...c.focused.map(m=>new V(m,E.Focused|f)),...d.focused.map(m=>new V(m,E.Focused|f)),new V(v,E.Focused|f|Te)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[u]},collisionPriority:1,radius:Bt,state:f}}function $t({vertices:e,padding:t,materials:i}){const a=s=>{const n=e.slice(0),r=k(o.get(),n[0],n[1]);A(r,r);const l=k(o.get(),n[n.length-1],n[n.length-2]);if(A(l,l),t>0){const ae=_(Z(),l,-t);n[n.length-1]=y(ae,ae,n[n.length-1]);const Y=_(Z(),r,-t);n[0]=y(Y,Y,n[0])}const u=s?ua:1,c=je*u,d=Bt*u,g=dt(x.get());if(t>0){const ae=c/4,Y=J(o.get(),0,ae,0),he=1+t/ae;ht(g,g,Y),At(g,g,J(o.get(),he,he,he)),ht(g,g,_(Y,Y,-1/he))}const v=dt(Se()),m=z(0,1,0),O=pt(Se(),gt(_t.get(),m,l));O[12]=n[n.length-1][0],O[13]=n[n.length-1][1],O[14]=n[n.length-1][2],K(O,O,g);const X=i.tube,j=Qa(_a*(s?oa:1)+t,n,X);j.transformation=v;const D=[j],De=i.tip,ie=vt(De,c,d,24,!1,!1,!0);ie.transformation=O,D.push(ie);const de=i.cap,Oe=vt(de,c,d,24,!1,!0,!1);Oe.transformation=O,D.push(Oe);const F=pt(Se(),gt(_t.get(),m,r));return F[12]=n[0][0],F[13]=n[0][1],F[14]=n[0][2],K(F,F,g),D.push(ie.instantiate({transformation:F})),D.push(Oe.instantiate({transformation:F})),D};return{normal:a(!1),focused:a(!0)}}function Qa(e,t,i){const a=[];for(let n=0;n<12;n++){const r=n/12*2*Math.PI;a.push([Math.cos(r)*e,Math.sin(r)*e])}return Ai(i,a,t,[],[],!1)}function es(e,t){const i=k(Z(),e[e.length-1],e[e.length-2]);if(A(i,i),_(i,i,je),y(i,i,e[e.length-1]),t){const a=k(Z(),e[0],e[1]);return A(a,a),_(a,a,je),y(a,a,e[0]),[a,...e,i]}return[...e,i]}var Be;let w=Be=class extends Qi{constructor(e){super(e),this._clock=ki,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this._layersMode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._frameTask=null,this._pointerMoveTimerMs=ca,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=b(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=Li(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=aa(e.view.state.viewingMode)}initialize(){var r;if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");const e=l=>{this._updateManipulatorsInteractive(l),l.grabbing||(this.analysisViewData.plane!=null&&P(this.analysisViewData.plane,this._startPlane),this.inputState=null)},t=new Ya(this.view,Ee.CENTER_ON_ARROW);this.shiftManipulator=t,this.manipulators.add(t),this.addHandles([this._createShiftDragPipeline(t),t.events.on("grab-changed",l=>{this._onShiftGrab(l),e(t)})]);const i=!((r=this.view._stage)!=null&&r.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result),a=new Et(this.view,(l,u)=>sa(this.view.textures,{accentColor:l,contrastColor:u,preMultiplyAlpha:i}));this.rotateHeadingManipulator=a,this.manipulators.add(a),this.addHandles([this._createRotateHeadingDragPipeline(a),a.events.on("grab-changed",l=>{this._onRotateHeadingGrab(l),e(a)})]);const s=new Et(this.view,(l,u)=>na(this.view.textures,{accentColor:l,contrastColor:u,preMultiplyAlpha:i}));this.rotateTiltManipulator=s,this.manipulators.add(s),this.addHandles([this._createRotateTiltDragPipeline(s),s.events.on("grab-changed",l=>{this._onRotateTiltGrab(l),e(s)})]),this.resizeManipulators=this._resizeHandles.map((l,u)=>{const c=new Ka(this.view,l);return this.addHandles([this._createResizeDragPipeline(c),c.events.on("grab-changed",d=>{this._onResizeGrab(d,u),e(c)})]),c}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=Xt(this.view),this._previewPlaneOutlineVisualElement=Zt(this.view),this._previewPlaneOutlineVisualElement.width=jt,this.addHandles(M(()=>[this.analysisViewData.plane,this.analysis.tiltEnabled],()=>this._updateManipulators(),Hi));const n=M(()=>this.state,l=>{l==="sliced"&&this.finishToolCreation()},Ue);this.addHandles([n,M(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=Q(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=Q(this._previewPlaneGridVisualElement)}get state(){const e=!!this.analysisViewData.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"}get cursor(){return this._isPlacingSlicePlane||this.layersMode==="exclude"?"crosshair":this._creatingPointerId!=null?"grabbing":null}set analysis(e){if(e==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this.removeHandles("analysis"),this._set("analysis",e)}get layersMode(){return this._layersMode}get inputState(){return this._get("inputState")}set inputState(e){this._set("inputState",e),this.analysisViewData.showGrid=e!=null&&e.type==="resize",this._updateMaterials()}get _isPlacingSlicePlane(){return!this.inputState&&!this.analysisViewData.plane&&this.active}get _creatingPointerId(){return this.inputState!=null&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){this.analysisViewData.plane!=null&&(this._layersMode="exclude",this.active||(this.view.activeTool=this))}exitExcludeLayerMode(){this.analysisViewData.plane!=null&&(this._layersMode="none",this.active&&(this.view.activeTool=null))}onDeactivate(){this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(e){this._updateManipulators(),e||this._clearPointerMoveTimeout()}onInputEvent(e){switch(e.type){case"pointer-drag":if(!Le(e))return;this._isPlacingSlicePlane?this._onClickPlacePlane(e)&&e.stopPropagation():this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e);break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"immediate-click":if(!Le(e))return;this._onClickPlacePlane(e)&&e.stopPropagation();break;case"click":if(!Le(e))return;this._onClickExcludeLayer(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(e){const t=this.inputState;if(e.pointerId===this._creatingPointerId&&t!=null&&t.type==="shift"){const i=se(e);return this.shiftManipulator.events.emit("drag",{action:t.hasBeenDragged?"update":"start",pointerType:e.pointerType,start:i,screenPoint:i}),t.hasBeenDragged=!0,!0}return!1}_onPointerMove(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),e.pointerType!=="touch"&&this._updatePreviewPlane(se(e),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(e){if(e.pointerId===this._creatingPointerId&&this.analysisViewData.plane!=null){const t=se(e);return this.shiftManipulator.events.emit("drag",{action:"end",start:t,screenPoint:t}),P(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(e){if(this.layersMode==="exclude")return!1;if(this._isPlacingSlicePlane){const t=se(e),i=b();if(this._pickPlane(t,!1,this._activeKeyModifiers,i)){if(e.type==="pointer-drag"){const a=ne(this.view.state.camera,t,le);this.inputState=Ct(a,e.pointerId,i.origin,i)}return P(i,this._startPlane),this.analysis.shape=Yt(i,this.view,this.view.spatialReference,new Xe),!0}}return!1}_onClickExcludeLayer(e){return!(this.layersMode!=="exclude"||!this.created)&&(this.view.hitTest(se(e)).then(t=>{if(t.results.length){const i=t.results[0],a=(i==null?void 0:i.type)==="graphic"&&i.graphic;if(a){const s=a.sourceLayer||a.layer;s&&this.analysis.excludedLayers.push(s)}}else t.ground.layer?this.analysis.excludedLayers.push(t.ground.layer):this.analysis.excludeGroundSurface=!0}),this.exitExcludeLayerMode(),!0)}_onKeyDown(e){return(e.key===xe||e.key===Re)&&(this._activeKeyModifiers[e.key]=!0,this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(e){return!(e.key!==xe&&e.key!==Re||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=ne(this.view.state.camera,e.screenPoint,le);P(this.analysisViewData.plane,this._startPlane),this.inputState=Ct(t,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(e){return ve(e,(t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="shift")return;const n=this.analysisViewData.plane!=null?P(this.analysisViewData.plane,b()):null;i.next(we(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{n!=null&&this._updateBoundedPlane(n)})})}_shiftDragAdjustSensitivity(e){return t=>{if(this.analysisViewData.plane==null)return null;const i=.001,a=Math.min((1-Math.abs(R(Me(this.analysisViewData.plane),t.ray.direction)/T(t.ray.direction)))/i,1),s=-wt(this._startPlane.plane,t.renderEnd),n=-wt(this._startPlane.plane,e.startPoint);return e.depth=e.depth*(1-a)+s*a-n,t}}_shiftDragUpdatePlane(e){return()=>{if(this.analysisViewData.plane==null)return;const t=I(o.get(),this._startPlane.origin),i=I(o.get(),Me(this._startPlane));_(i,i,-e.depth),y(i,i,t);const a=He(i,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,b());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=Mt(this.analysisViewData.plane,this.view.renderCoordsHelper,ee.HEADING,ze()),i=ne(this.view.state.camera,e.screenPoint,le),a=Z();fe(t,i,a)&&(P(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateHeadingDragPipeline(e){return ve(e,(t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const n=this.analysisViewData.plane!=null?P(this.analysisViewData.plane,b()):null;i.next(we(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{n!=null&&this._updateBoundedPlane(n)})})}_onRotateTiltGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=Mt(this.analysisViewData.plane,this.view.renderCoordsHelper,ee.TILT,ze()),i=ne(this.view.state.camera,e.screenPoint,le),a=Z();fe(t,i,a)&&(P(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateTiltDragPipeline(e){return ve(e,(t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const n=this.analysisViewData.plane!=null?P(this.analysisViewData.plane,b()):null;i.next(we(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{n!=null&&this._updateBoundedPlane(n)})})}_rotateDragRenderPlaneToRotate(e){return t=>{if(this.analysisViewData.plane==null)return null;const i=Ie(e.rotatePlane),a=ea(e.startPoint,t.renderEnd,this.analysisViewData.plane.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdatePlaneFromRotate(){return e=>{if(this.analysisViewData.plane==null)return;const t=Gi(x.get(),e.rotateAngle,e.rotateAxis);if(t==null)return;const i=yt(o.get(),this._startPlane.basis1,t),a=yt(o.get(),this._startPlane.basis2,t),s=He(this.analysisViewData.plane.origin,i,a,b());this._updateBoundedPlane(s)}}_onResizeGrab(e,t){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const i=ne(this.view.state.camera,e.screenPoint,le),a=o.get();fe(this.analysisViewData.plane.plane,i,a)&&(P(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:xt(a)})}_createResizeDragPipeline(e){return ve(e,(t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="resize"||this.analysisViewData.plane==null)return;const n=P(this.analysisViewData.plane,b());i.next(we(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(n)})})}_resizeDragUpdatePlane(e){return t=>{if(this.analysisViewData.plane==null)return;const i=this._resizeHandles[e.activeHandleIdx],a=Sa(i,e.startPoint,t.renderEnd,this.view.state.camera,this._startPlane,P(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(e){const t=this.analysisViewData;if(t==null)throw new Error("valid internal object expected");t.plane=e}_updatePreviewPlane(e,t={}){let i=this._previewPlane;if(this._previewPlane=null,e==null)return this._removeFrameTask(),void this._updateManipulators();if(!this.analysisViewData.plane&&this.active){const a=i??b();if(i=i!=null?P(i,ts):null,this._pickPlane(e,!0,t,a)){const s=pa;let n=!1;i!=null&&(n=R(Ie(i.plane),Ie(a.plane))<s||R(A(o.get(),i.basis1),A(o.get(),a.basis1))<s),n&&(this._previewPlaneOpacity=0),this._previewPlane=a}}this._previewPlane!=null&&this._frameTask==null&&this._previewPlaneOpacity===0?this._frameTask=Ni({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*ga),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):this._previewPlane==null&&this._frameTask!=null?this._removeFrameTask():this._previewPlane!=null&&this._updateManipulators()}_removeFrameTask(){this._frameTask=mt(this._frameTask)}_pickMinResult(e){const t=Ui(e,zi.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min}_pickPlane(e,t,i,a){const s=this._pickMinResult(e),n=o.get();if(!s.getIntersectionPoint(n))return!1;const r=s.getTransformedNormal(o.get()),l=this.view.state.camera;R(r,l.viewForward)>0&&_(r,r,-1);const u=Ia(n,l),c=(t?1:-1)*u*da,d=_(o.get(),r,c);y(d,d,n);const g=this.analysis.tiltEnabled?$.TILTED:$.HORIZONTAL_OR_VERTICAL,v=i[xe]?$.VERTICAL:i[Re]?$.HORIZONTAL:g;return Ca(d,r,u,u,l,v,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=mt(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=f,this.rotateHeadingManipulator.state|=f,this.rotateTiltManipulator.state|=f,this._prevPointerMoveTimeout=this._clock.setTimeout(()=>{this.shiftManipulator.state&=~f,this.rotateHeadingManipulator.state&=~f,this.rotateTiltManipulator.state&=~f},this._pointerMoveTimerMs)}_updateManipulators(){if(Be.disableEngineLayers)return;let e,t=!1;if(this.analysisViewData.plane!=null)e=this.analysisViewData.plane,t=!1;else{if(this._previewPlane==null)return this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(r=>r.available=!1),this._previewPlaneOutlineVisualElement.visible=!1,void(this._previewPlaneGridVisualElement.visible=!1);e=this._previewPlane,t=!0}const i=qt(e,x.get());t?(this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(r=>r.available=!1),this._previewPlaneOutlineVisualElement.attached=!0,this._previewPlaneGridVisualElement.attached=!0,this._previewPlaneOutlineVisualElement.visible=!0,this._previewPlaneGridVisualElement.visible=!0):(this.shiftManipulator.available=!0,this.rotateHeadingManipulator.available=!0,this.rotateTiltManipulator.available=this.analysis.tiltEnabled,this.resizeManipulators.forEach(r=>r.available=!0),xa(this.shiftManipulator,i,e,this.view.state.camera),La(this.rotateHeadingManipulator,i,e,this.view.renderCoordsHelper),Ha(this.rotateTiltManipulator,i,e),this.resizeManipulators.forEach((r,l)=>ka(r,this._resizeHandles[l],i,e)),this._previewPlaneOutlineVisualElement.visible=!1,this._previewPlaneGridVisualElement.visible=!1);const a=J(o.get(),T(e.basis1),T(e.basis2),1),s=Gt(x.get(),a),n=K(s,i,s);this._previewPlaneOutlineVisualElement.transform=n,this._previewPlaneGridVisualElement.transform=n,this._updateMaterials()}_updateMaterials(){const e=Je(this.view.effectiveTheme);e[3]*=this._previewPlaneOpacity;const t=ji(Ye);t[3]*=this._previewPlaneOpacity,this._previewPlaneOutlineVisualElement.color=e,this._previewPlaneGridVisualElement.backgroundColor=t,this._previewPlaneGridVisualElement.gridColor=Nt}_updateManipulatorsInteractive(e){if(!e.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(t=>{t.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===e,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===e,this.resizeManipulators.forEach(t=>{t.interactive=t===e})}testData(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:e=>{this._pointerMoveTimerMs=e}}}};function Ct(e,t,i,a){const s=Ra(i,Me(a),e.direction,ze()),n=Z();return fe(s,e,n)?{type:"shift",creatingPointerId:t,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:n}:null}function Le(e){return e.pointerType!=="mouse"||e.button===0}w.disableEngineLayers=!1,h([p()],w.prototype,"_clock",void 0),h([p({constructOnly:!0})],w.prototype,"view",void 0),h([p()],w.prototype,"analysisViewData",void 0),h([p({readOnly:!0})],w.prototype,"state",null),h([p({readOnly:!0})],w.prototype,"cursor",null),h([p()],w.prototype,"analysis",null),h([p()],w.prototype,"removeIncompleteOnCancel",void 0),h([p()],w.prototype,"_layersMode",void 0),h([p()],w.prototype,"layersMode",null),h([p({value:null})],w.prototype,"inputState",null),h([p()],w.prototype,"_isPlacingSlicePlane",null),h([p()],w.prototype,"_creatingPointerId",null),w=Be=h([ce("esri.views.3d.analysis.Slice.SliceTool")],w);const ts=b(),le=St(),is=w;let G=class extends qe{constructor(e){super(e),this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const e=this.analysisViewData;if(e==null)throw new Error("expected internal object to be valid");this._gridVisualElement=Xt(this.view),this._outlineVisualElement=Zt(this.view),this.addHandles([M(()=>{const t=e.plane!=null&&this.analysisViewData.visible,{active:i}=this.analysisViewData,{preview:a,showGrid:s,view:n}=this,{effectiveTheme:r}=n;return{visible:t,active:i,preview:a,showGrid:s,gridColor:zt(r),outlineColor:Je(r)}},t=>this._updateMaterials(t),Ue),M(()=>e.plane,t=>this._updatePlane(t),Ue)],"internal")}destroy(){this._gridVisualElement=Q(this._gridVisualElement),this._outlineVisualElement=Q(this._outlineVisualElement),this.set("view",null)}_updatePlane(e){if(e==null)return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const t=J(o.get(),T(e.basis1),T(e.basis2),1),i=Gt(x.get(),t),a=qt(e,x.get()),s=K(i,a,i);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:e,active:t,preview:i,showGrid:a,gridColor:s,outlineColor:n}){this._outlineVisualElement.color=n,this._outlineVisualElement.width=i?jt:Ft,this._outlineVisualElement.stipplePattern=t?null:Fi(5),this._gridVisualElement.backgroundColor=Ye,this._gridVisualElement.gridColor=a?s:Nt,this._gridVisualElement.visible=e,this._outlineVisualElement.visible=e}};h([p()],G.prototype,"view",void 0),h([p()],G.prototype,"analysis",void 0),h([p()],G.prototype,"analysisViewData",void 0),h([p()],G.prototype,"showGrid",void 0),h([p()],G.prototype,"preview",void 0),G=h([ce("esri.views.3d.analysis.Slice.SliceVisualization")],G);let S=class extends Zi(qe){constructor(e){super(e),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0}initialize(){this.analysisVisualization=new G({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new B({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles(ta(this,is))}destroy(){ia(this),this.analysisVisualization=Q(this.analysisVisualization),this.analysisController=Q(this.analysisController)}get showGrid(){var e;return((e=this.analysisVisualization)==null?void 0:e.showGrid)??!1}set showGrid(e){this.analysisVisualization&&(this.analysisVisualization.showGrid=e)}get editable(){return!this.analysisVisualization.preview}set editable(e){this.analysisVisualization.preview=!e}get testData(){return{visualization:this.analysisVisualization,controller:this.analysisController,tool:this.tool}}};h([p({readOnly:!0})],S.prototype,"type",void 0),h([p({constructOnly:!0,nonNullable:!0})],S.prototype,"analysis",void 0),h([p()],S.prototype,"tool",void 0),h([p()],S.prototype,"plane",void 0),h([p()],S.prototype,"active",void 0),h([p()],S.prototype,"showGrid",null),h([p()],S.prototype,"editable",null),S=h([ce("esri.views.3d.analysis.SliceAnalysisView3D")],S);const yn=S,as=Object.freeze(Object.defineProperty({__proto__:null,build:Wt},Symbol.toStringTag,{value:"Module"}));export{yn as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
