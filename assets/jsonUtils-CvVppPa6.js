import{e as i,y as r,bp as V,aj as w,eP as le,c as $,eo as ae,ar as ue,mJ as pe,q as D,U as G,cD as ye,a as de,iL as ce,mK as he,bq as d,hq as me,mL as ge,mM as fe,l7 as z,la as q,b0 as K,hS as R,eW as be,l8 as we,eI as U,ai as Q,c7 as J,bF as L,az as ve,f7 as xe,eK as X,kM as Se,lj as $e,fS as Y,mN as _e,cF as je,bD as ee,bA as Ie,a9 as De}from"./index-Bv0Hohk0.js";import{A as te,w as ie}from"./UniqueValueRenderer-C8B84zcF.js";import{Z as Pe}from"./FieldsIndex-j25pkYvJ.js";import{a as Ee,e as Ve,c as Re}from"./heatmapUtils-CpfvS1IE.js";var O;let N=O=class extends V{constructor(t){super(t),this.color=null,this.ratio=null}clone(){return new O({color:this.color&&this.color.clone(),ratio:this.ratio})}};i([r({type:w,json:{type:[le],default:null,write:!0}})],N.prototype,"color",void 0),i([r({type:Number,json:{write:!0}})],N.prototype,"ratio",void 0),N=O=i([$("esri.renderers.support.HeatmapColorStop")],N);const C=N,Z="esri.renderers.support.DictionaryLoader",Ne={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};class se{constructor(e,s,o){this.config=null,this.fieldMap=null,this.url=null,this._ongoingRequests=new Map,this._symbolCache=new ae(100),this._dictionaryVersion=null,this._fieldIndex=null,this._dictionaryPromise=null,this.url=e,this.config=s,this.fieldMap=o}getSymbolFields(){return this._symbolFields}async getSymbolAsync(e,s){let o;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(s));try{o=await this._dictionaryPromise}catch(p){if(ue(p))return this._dictionaryPromise=null,null}const a=this._dictionaryVersion&&this._dictionaryVersion.since(4,0),u={};if(this.fieldMap)for(const p of this._symbolFields){const c=pe(this.fieldMap[p],this._fieldIndex);if(c){const l=e.attributes[c];u[p]=a?l:l!=null?""+e.attributes[c]:""}else u[p]=""}let n=null;try{n=o==null?void 0:o(u,s)}catch{return null}if(!n||typeof n!="string"||n==="invalid")return null;const S=n.split(";"),j=[],m=[];for(const p of S)if(p)if(p.includes("po:")){const c=p.substr(3).split("|");if(c.length===3){const l=c[0],g=c[1];let f=c[2];if(g==="DashTemplate")f=f.split(" ").map(v=>Number(v));else if(g==="Color"){const v=new w(f).toRgba();f=[v[0],v[1],v[2],255*v[3]]}else f=Number(f);m.push({primitiveName:l,propertyName:g,value:f,defaultValue:null})}}else if(p.includes("|")){for(const c of p.split("|"))if(this._itemNames.has(c)){j.push(c);break}}else this._itemNames.has(p)&&j.push(p);const P=e.geometry==null||!e.geometry.hasZ&&e.geometry.type==="point";return this._cimPartsToCIMSymbol(e,j,m,P,s)}async fetchResources(e){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void D.getLogger(Z).error("no valid URL!");const s=G(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},signal:e!=null?e.signal:null}),[{data:o}]=await Promise.all([s,ye()]);if(!o)throw this._dictionaryPromise=null,new de("esri.renderers.DictionaryRenderer","Bad dictionary data!");const{authoringInfo:a,dictionary_version:u,expression:n,itemsNames:S}=o,j=n;let m=!1;u&&(this._dictionaryVersion=ce.parse(u),m=this._dictionaryVersion.since(4,0)),this._refSymbolUrlTemplate=this.url+"/"+o.cimRefTemplateUrl,this._itemNames=new Set(S),this._symbolFields=a.symbol;const P={};if(this.config){const l=this.config;for(const g in l)P[g]=l[g]}if(a.configuration)for(const l of a.configuration)P.hasOwnProperty(l.name)||(P[l.name]=l.value);const p=[];if(e!=null&&e.fields&&this.fieldMap)for(const l in this.fieldMap){const g=this.fieldMap[l],f=e.fields.filter(v=>v.name.toLowerCase()===(g==null?void 0:g.toLowerCase()));f.length>0&&p.push({...f[0],type:m?f[0].type:"esriFieldTypeString"})}p.length>0&&(this._fieldIndex=new Pe(p));const c=he(j,e!=null?e.spatialReference:null,p,P).then(l=>{const g={scale:0};return(f,v)=>{if(l==null)return null;const ne=l.repurposeFeature({geometry:null,attributes:f});return g.scale=v!=null?v.scale??void 0:void 0,l.evaluate({$feature:ne,$view:g},l.services)}}).catch(l=>(D.getLogger(Z).error("Creating dictinoary expression failed:",l),null));return this._dictionaryPromise=c,c}async _cimPartsToCIMSymbol(e,s,o,a,u){const n=new Array(s.length);for(let m=0;m<s.length;m++)n[m]=this._getSymbolPart(s[m],u);let S=await Promise.all(n);const j=this.fieldMap;if(j){S=d(S);for(const m of S)me.applyDictionaryTextOverrides(m,e,j,this._fieldIndex,ge(m))}return new fe({data:this._combineSymbolParts(S,o,a)})}async _getSymbolPart(e,s){const o=this._symbolCache.get(e);if(o)return o;if(this._ongoingRequests.has(e))return this._ongoingRequests.get(e).then(n=>n.data);const a=this._refSymbolUrlTemplate.replaceAll(/\{itemName\}/gi,e),u=G(a,{responseType:"json",query:{f:"json"},...s});this._ongoingRequests.set(e,u),u.finally(()=>this._ongoingRequests.delete(e));try{const n=await u;return this._symbolCache.put(e,n.data),n.data}catch(n){throw n}}_combineSymbolParts(e,s,o){if(!e||e.length===0)return null;const a={...e[0]};if(e.length>1){a.symbolLayers=[];for(const u of e){const n=u;a.symbolLayers.unshift(...n.symbolLayers)}}return o&&(a.callout=Ne),{type:"CIMSymbolReference",symbol:a,primitiveOverrides:s}}}var A;let x=A=class extends z(R){constructor(t){super(t),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type="dictionary"}get _loader(){return new se(this.url,this.config,this.fieldMap)}writeData(t,e){t&&(e.scalingExpressionInfo={expression:t,returnType:"number"})}writeVisualVariables(t,e,s,o){o!=null&&o.origin||super.writeVisualVariables(t,e,s,o)}clone(){return new A({config:d(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:d(this.fieldMap),url:d(this.url),visualVariables:d(this.visualVariables)})}async getSymbolAsync(t,e){return this._loader.getSymbolAsync(t,e)}async collectRequiredFields(t,e){await this.collectVVRequiredFields(t,e),this.scaleExpression&&await q(t,e,this.scaleExpression);for(const s in this.fieldMap){const o=this.fieldMap[s];e.has(o)&&t.add(o)}}get arcadeRequired(){return!0}getSymbol(){return null}getSymbols(){return[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}getSymbolFields(){return this._loader.getSymbolFields()}};i([r({type:se})],x.prototype,"_loader",null),i([r({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],x.prototype,"config",void 0),i([r({type:Object,json:{write:!0}})],x.prototype,"fieldMap",void 0),i([r({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],x.prototype,"scaleExpression",void 0),i([K("scaleExpression")],x.prototype,"writeData",null),i([r({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(t){return{enabled:!!t&&!!this.scaleExpression}}}}})],x.prototype,"scaleExpressionTitle",void 0),i([r({type:String,json:{write:!0}})],x.prototype,"url",void 0),i([K("visualVariables")],x.prototype,"writeVisualVariables",null),x=A=i([$("esri.renderers.DictionaryRenderer")],x);const Ce=x;var F;let _=F=class extends V{constructor(t){super(t),this.color=null,this.field=null,this.label=null,this.valueExpression=null,this.valueExpressionTitle=null}castField(t){return t==null?t:typeof t=="function"?(D.getLogger(this).error(".field: field must be a string value"),null):we(t)}getAttributeHash(){return`${this.field}-${this.valueExpression}`}clone(){var t;return new F({color:(t=this.color)==null?void 0:t.clone(),field:this.field,label:this.label,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};i([r({type:w,json:{type:[Number],write:!0}})],_.prototype,"color",void 0),i([r({type:String,json:{write:!0}})],_.prototype,"field",void 0),i([be("field")],_.prototype,"castField",null),i([r({type:String,json:{write:!0}})],_.prototype,"label",void 0),i([r({type:String,json:{write:!0}})],_.prototype,"valueExpression",void 0),i([r({type:String,json:{write:!0}})],_.prototype,"valueExpressionTitle",void 0),_=F=i([$("esri.renderers.support.AttributeColorInfo")],_);const re=_;var k;let T=k=class extends V{constructor(){super(...arguments),this.unit=null}clone(){return new k({unit:this.unit})}};i([r({type:String,json:{write:!0}})],T.prototype,"unit",void 0),T=k=i([$("esri.renderers.support.DotDensityLegendOptions")],T);const Te=T;var H;let h=H=class extends z(R){constructor(t){super(t),this.attributes=null,this.backgroundColor=new w([0,0,0,0]),this.dotBlendingEnabled=!0,this.dotShape="square",this.dotSize=1,this.legendOptions=null,this.outline=new U,this.dotValue=null,this.referenceScale=null,this.seed=1,this.type="dot-density"}calculateDotValue(t){if(this.referenceScale==null)return this.dotValue;const e=t/this.referenceScale*this.dotValue;return e<1?1:e}getSymbol(){return new Q({outline:this.outline})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}getAttributeHash(){var t;return((t=this.attributes)==null?void 0:t.reduce((e,s)=>e+s.getAttributeHash(),""))??""}getMeshHash(){return JSON.stringify(this.outline)}clone(){return new H({attributes:d(this.attributes),backgroundColor:d(this.backgroundColor),dotBlendingEnabled:d(this.dotBlendingEnabled),dotShape:d(this.dotShape),dotSize:d(this.dotSize),dotValue:d(this.dotValue),legendOptions:d(this.legendOptions),outline:d(this.outline),referenceScale:d(this.referenceScale),seed:d(this.seed),visualVariables:d(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}getControllerHash(){var e;return`${(e=this.attributes)==null?void 0:e.map(s=>s.field||s.valueExpression||"")}-${this.outline&&JSON.stringify(this.outline.toJSON())||""}`}async collectRequiredFields(t,e){await this.collectVVRequiredFields(t,e);for(const s of this.attributes??[])s.valueExpression&&await q(t,e,s.valueExpression),s.field&&t.add(s.field)}};i([r({type:[re],json:{write:!0}})],h.prototype,"attributes",void 0),i([r({type:w,json:{write:!0}})],h.prototype,"backgroundColor",void 0),i([r({type:Boolean,json:{write:!0}})],h.prototype,"dotBlendingEnabled",void 0),i([r({type:String,json:{write:!1}})],h.prototype,"dotShape",void 0),i([r({type:Number,json:{write:!0}})],h.prototype,"dotSize",void 0),i([r({type:Te,json:{write:!0}})],h.prototype,"legendOptions",void 0),i([r({type:U,json:{default:null,write:!0}})],h.prototype,"outline",void 0),i([r({type:Number,json:{write:!0}})],h.prototype,"dotValue",void 0),i([r({type:Number,json:{write:!0}})],h.prototype,"referenceScale",void 0),i([r({type:Number,json:{write:!0}})],h.prototype,"seed",void 0),i([J({dotDensity:"dot-density"})],h.prototype,"type",void 0),h=H=i([$("esri.renderers.DotDensityRenderer")],h);const Me=h;let E=class extends L(V){constructor(){super(...arguments),this.minLabel=null,this.maxLabel=null,this.title=null}};i([r({type:String,json:{write:!0}})],E.prototype,"minLabel",void 0),i([r({type:String,json:{write:!0}})],E.prototype,"maxLabel",void 0),i([r({type:String,json:{write:!0}})],E.prototype,"title",void 0),E=i([$("esri.renderers.support.HeatmapLegendOptions")],E);var B;function W(t){if(t!=null){const{maxDensity:e,minDensity:s,radius:o}=t;if(e!=null||s!=null||o!=null){const{blurRadius:a,maxPixelIntensity:u,minPixelIntensity:n,...S}=t;return S}}return t}let y=B=class extends R{constructor(t){super(t),this.authoringInfo=null,this.colorStops=[new C({ratio:0,color:new w("rgba(255, 140, 0, 0)")}),new C({ratio:.75,color:new w("rgba(255, 140, 0, 1)")}),new C({ratio:.9,color:new w("rgba(255, 0,   0, 1)")})],this.field=null,this.legendOptions=null,this.maxDensity=.04,this.minDensity=0,this.radius=18,this.referenceScale=0,this.type="heatmap",this.valueExpression=null,this.valueExpressionTitle=null,this._warnedProps={blurRadius:!1,maxPixelIntensity:!1,minPixelIntensity:!1}}normalizeCtorArgs(t){return W(t)}get blurRadius(){return Ee(this.radius)}set blurRadius(t){const e=this.maxPixelIntensity,s=this.minPixelIntensity;this._set("radius",Ve(t)),this._warnAboutDeprecatedGaussianBlurProp("blurRadius","radius"),this._set("maxDensity",e*this._pixelIntensityToDensity),this._set("minDensity",s*this._pixelIntensityToDensity)}get maxPixelIntensity(){return this.maxDensity/this._pixelIntensityToDensity}set maxPixelIntensity(t){this._set("maxDensity",t*this._pixelIntensityToDensity),this._warnAboutDeprecatedGaussianBlurProp("maxPixelIntensity","maxDensity")}get minPixelIntensity(){return this.minDensity/this._pixelIntensityToDensity}set minPixelIntensity(t){this._set("minDensity",t*this._pixelIntensityToDensity),this._warnAboutDeprecatedGaussianBlurProp("minPixelIntensity","minDensity")}get _pixelIntensityToDensity(){return 24/(Re**2*this.blurRadius**4)}_warnAboutDeprecatedGaussianBlurProp(t,e){this._warnedProps[t]||ve(this).getDefaultOrigin()==="user"&&(this._warnedProps[t]=!0,xe(()=>{_e(D.getLogger(this),t,{replacement:`${String(e)} (suggested value: ${this._get(e)})`,version:"4.24"})}))}read(t,e){t=W(t),super.read(t,e)}getSymbol(){return new X}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}async collectRequiredFields(t,e){const s=this.field,o=this.valueExpression;s&&typeof s=="string"&&Se(t,e,s),o&&typeof o=="string"&&await q(t,e,o)}getAttributeHash(){return null}getMeshHash(){return`${JSON.stringify(this.colorStops)}.${this.blurRadius}.${this.field}`}clone(){return new B({authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),colorStops:d(this.colorStops),field:this.field,legendOptions:d(this.legendOptions),maxDensity:this.maxDensity,minDensity:this.minDensity,radius:this.radius,referenceScale:this.referenceScale,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};i([r({type:$e,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],y.prototype,"authoringInfo",void 0),i([r({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],y.prototype,"blurRadius",null),i([r({type:[C],json:{write:!0}})],y.prototype,"colorStops",void 0),i([r({type:String,json:{write:!0}})],y.prototype,"field",void 0),i([r({type:E,json:{write:!0}})],y.prototype,"legendOptions",void 0),i([r({type:Number,json:{write:!0}})],y.prototype,"maxDensity",void 0),i([r({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],y.prototype,"maxPixelIntensity",null),i([r({type:Number,json:{write:!0}})],y.prototype,"minDensity",void 0),i([r({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],y.prototype,"minPixelIntensity",null),i([r({type:Number,cast:Y,json:{write:!0}})],y.prototype,"radius",void 0),i([r({type:Number,range:{min:0},json:{default:0,write:!0}})],y.prototype,"referenceScale",void 0),i([J({heatmap:"heatmap"})],y.prototype,"type",void 0),i([r({type:String,json:{write:!0,origins:{"web-document":{write:!1},"portal-item":{write:!1}}}})],y.prototype,"valueExpression",void 0),i([r({type:String})],y.prototype,"valueExpressionTitle",void 0),i([r({readOnly:!0})],y.prototype,"_pixelIntensityToDensity",null),y=B=i([$("esri.renderers.HeatmapRenderer")],y);const oe=y;let I=class extends L(V){constructor(){super(...arguments),this.color=new w([0,0,0,0]),this.label=null,this.threshold=0}};i([r({type:w,json:{write:!0}})],I.prototype,"color",void 0),i([r({type:String,json:{write:!0}})],I.prototype,"label",void 0),i([r({type:Number,range:{min:0,max:1},json:{write:!0}})],I.prototype,"threshold",void 0),I=i([$("esri.renderers.support.OthersCategory")],I);let M=class extends L(V){constructor(){super(...arguments),this.title=null}};i([r({type:String,json:{write:!0}})],M.prototype,"title",void 0),M=i([$("esri.renderers.support.PieChartLegendOptions")],M);let b=class extends z(L(R)){constructor(e){super(e),this.attributes=null,this.backgroundFillSymbol=null,this.defaultColor=new w([0,0,0,0]),this.defaultLabel=null,this.holePercentage=0,this.othersCategory=new I,this.legendOptions=null,this.outline=null,this.size=12,this.type="pie-chart"}getSymbol(){var e;return new X({size:this.size?this.size/2+(((e=this.outline)==null?void 0:e.width)||0):0})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol(),this.backgroundFillSymbol].filter(je)}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,s)=>e+s.getAttributeHash(),"")}getMeshHash(){return this.getSymbols().reduce((e,s)=>e+JSON.stringify(s),"")}async collectRequiredFields(e,s){await this.collectVVRequiredFields(e,s);for(const o of this.attributes)o.valueExpression&&await q(e,s,o.valueExpression),o.field&&e.add(o.field)}};i([r({type:[re],json:{write:!0}})],b.prototype,"attributes",void 0),i([r({type:Q,json:{default:null,write:!0}})],b.prototype,"backgroundFillSymbol",void 0),i([r({type:w,json:{write:!0}})],b.prototype,"defaultColor",void 0),i([r({type:String,json:{write:!0}})],b.prototype,"defaultLabel",void 0),i([r({type:Number,range:{min:0,max:1},json:{write:!0}})],b.prototype,"holePercentage",void 0),i([r({type:I,json:{write:!0}})],b.prototype,"othersCategory",void 0),i([r({type:M,json:{write:!0}})],b.prototype,"legendOptions",void 0),i([r({type:U,json:{default:null,write:!0}})],b.prototype,"outline",void 0),i([r({type:Number,cast:Y,json:{write:!0}})],b.prototype,"size",void 0),i([J({pieChart:"pie-chart"})],b.prototype,"type",void 0),b=i([$("esri.renderers.PieChartRenderer")],b);const qe=b,Le={key:"type",base:R,typeMap:{heatmap:oe,simple:ee,"unique-value":te,"class-breaks":ie,"dot-density":Me,dictionary:Ce,"pie-chart":qe},errorContext:"renderer"},Qe={key:"type",base:R,typeMap:{simple:ee,"unique-value":te,"class-breaks":ie,heatmap:oe},errorContext:"renderer",validate:Oe};function Oe(t){switch(t.type){case"simple":return Ae(t);case"unique-value":return Fe(t);case"class-breaks":return ke(t);case"heatmap":return t}}function Ae(t){if(t.symbol)return t;D.getLogger("esri.renderers.support.types").error("Removed invalid 'simple' renderer without a symbol from web scene.")}function Fe(t){const e=t.uniqueValueInfos,s=e==null?void 0:e.filter(({symbol:o,label:a},u)=>(o||D.getLogger("esri.renderers.support.types").error(`Removed invalid unique value info ([${u}] ${a}) without a symbol from web scene.`),!!o));return(s==null?void 0:s.length)!==(e==null?void 0:e.length)&&(t.uniqueValueInfos=s),t}function ke(t){const e=t.classBreakInfos,s=e==null?void 0:e.filter(({symbol:o,label:a},u)=>(o||D.getLogger("esri.renderers.support.types").error(`Removed invalid class break info ([${u}] ${a}) without a symbol from web scene.`),!!o));return(s==null?void 0:s.length)!==(e==null?void 0:e.length)&&(t.classBreakInfos=s),t}function Xe(t,e){return Be(t,null,e)}const He=Ie({types:Le});function Be(t,e,s){return t?t&&(t.styleName||t.styleUrl)&&t.type!=="uniqueValue"?(s!=null&&s.messages&&s.messages.push(new De("renderer:unsupported","Only UniqueValueRenderer can be referenced from a web style, but found '"+t.type+"'",{definition:t,context:s})),null):He(t,e,s):null}export{C as l,Le as m,Be as o,Xe as t,Qe as u};
