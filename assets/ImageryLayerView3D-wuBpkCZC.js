import{e as o,y as d,c as w,a as h,g as D,aw as E,ba as c,O as b,w as _}from"./index-Bv0Hohk0.js";import{N as H}from"./DynamicLayerView3D-BkWtl3DK.js";import{j as I}from"./commonProperties-71l2LJ6s.js";import{p as P}from"./popupUtils-D-6l6-mq.js";import"./LayerView3D-BHAdUlxy.js";import"./projectExtentUtils-jytcdcl1.js";import"./ImageMaterial.glsl-B_fxTFoc.js";import"./LayerView-xIua26SL.js";import"./RefreshableLayerView-ByEXgiMo.js";const F=e=>{let t=class extends e{constructor(){super(...arguments),this.view=null}async fetchPopupFeaturesAtLocation(a,s){const{layer:n}=this;if(!a)throw new h("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:n});const{popupEnabled:i}=n,r=P(n,s);if(!i||r==null)throw new h("imagerylayerview:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:i,popupTemplate:r});const g=await r.getRequiredFields();D(s);const p=new E;p.timeExtent=this.timeExtent,p.geometry=a,p.outFields=g,p.outSpatialReference=a.spatialReference;const{resolution:l,spatialReference:u}=this.view,y=this.view.type==="2d"?new c(l,l,u):new c(.5*l,.5*l,u),{returnTopmostRaster:x,showNoDataRecords:f}=r.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},v={returnDomainValues:!0,returnTopmostRaster:x,pixelSize:y,showNoDataRecords:f,signal:s==null?void 0:s.signal};return n.queryVisibleRasters(p,v).then(R=>R)}canResume(){var a;return!!super.canResume()&&!((a=this.timeExtent)!=null&&a.isEmpty)}};return o([d()],t.prototype,"layer",void 0),o([d()],t.prototype,"suspended",void 0),o([d(I)],t.prototype,"timeExtent",void 0),o([d()],t.prototype,"view",void 0),t=o([w("esri.views.layers.ImageryLayerView")],t),t};let m=class extends F(H){constructor(){super(...arguments),this.type="imagery-3d",this.redrawDebounced=b(async e=>{this.redraw((t,a)=>this._redrawImage(t,a),e)},2e3)}initialize(){this.addHandles([_(()=>this.view.basemapTerrain.ready,()=>this._initializeMaximumDataResolution(),{once:!0,initial:!0}),this.layer.on("redraw",()=>this._updatingHandles.addPromise(this.redrawDebounced()))]),this._updatingHandles.add(()=>{var e,t;return(t=(e=this.layer)==null?void 0:e.exportImageServiceParameters)==null?void 0:t.version},()=>{this._updatingHandles.addPromise(this.refreshDebounced())}),this._updatingHandles.add(()=>{var e;return(e=this.layer)==null?void 0:e.renderer},()=>{this._updatingHandles.addPromise(this.refreshDebounced())}),this._updatingHandles.add(()=>this.timeExtent,()=>this._updatingHandles.addPromise(this.refreshDebounced()))}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}getFetchOptions(){return{timeExtent:this.timeExtent}}async processResult(e,t,a){t.imageOrCanvasElement?e.image=t.imageOrCanvasElement:(e.image=document.createElement("canvas"),e.pixelData=t.pixelData,await this._redrawImage(e,a))}async _redrawImage(e,t){if(!(e.image instanceof HTMLCanvasElement)||e.pixelData==null)throw new Error;const a=e.image,s=a.getContext("2d"),n=await this.layer.applyRenderer(e.pixelData,{signal:t}),i=this.layer.applyFilter(n).pixelBlock;if(i==null)throw new Error;a.width=i.width,a.height=i.height;const r=s.createImageData(i.width,i.height);r.data.set(i.getAsRGBA()),s.putImageData(r,0,0)}};m=o([w("esri.views.3d.layers.ImageryLayerView3D")],m);const $=m;export{$ as default};
