import{e5 as D,cF as v,e6 as d,af as m,e7 as y,e8 as h,e9 as $,ea as M,eb as g,ec as I}from"./index-Bv0Hohk0.js";import{u as w,c as p,i as O,f as S}from"./PointCloudWorkerUtil-DmayABs6.js";import"./PointCloudUniqueValueRenderer-CAdBY5WK.js";import"./I3SBinaryReader-DZo_O6Xi.js";class _{transform(t){const a=this._transform(t),e=[a.points.buffer,a.rgb.buffer];a.pointIdFilterMap!=null&&e.push(a.pointIdFilterMap.buffer);for(const r of a.attributes)"buffer"in r.values&&D(r.values.buffer)&&r.values.buffer!==a.rgb.buffer&&e.push(r.values.buffer);return Promise.resolve({result:a,transferList:e})}_transform(t){const a=w(t.schema,t.geometryBuffer);let e=a.length/3,r=null;const l=new Array,b=p(t.primaryAttributeData,a,e);t.primaryAttributeData!=null&&b&&l.push({attributeInfo:t.primaryAttributeData.attributeInfo,values:b});const o=p(t.modulationAttributeData,a,e);t.modulationAttributeData!=null&&o&&l.push({attributeInfo:t.modulationAttributeData.attributeInfo,values:o});let n=O(t.rendererInfo,b,o,e);if(t.filterInfo&&t.filterInfo.length>0&&t.filterAttributesData!=null){const s=t.filterAttributesData.filter(v).map(i=>{const u=p(i,a,e),c={attributeInfo:i.attributeInfo,values:u};return l.push(c),c});r=new Uint32Array(e),e=S(a,n,r,t.filterInfo,s)}for(const s of t.userAttributesData){const i=p(s,a,e);l.push({attributeInfo:s.attributeInfo,values:i})}3*e<n.length&&(n=new Uint8Array(n.buffer.slice(0,3*e))),this._applyElevationOffsetInPlace(a,e,t.elevationOffset);const f=this._transformCoordinates(a,e,d.fromData(t.obbData),m.fromJSON(t.inSR),m.fromJSON(t.outSR));return{obbData:t.obbData,points:f,rgb:n,attributes:l,pointIdFilterMap:r}}_transformCoordinates(t,a,e,r,l){if(!y(t,r,0,t,l,0,a))throw new Error("Can't reproject");const b=h(e.center),o=I(),n=I(),f=h(e.halfSize);$(A,e.quaternion);const s=new Float32Array(3*a);for(let i=0;i<a;i++){let u=3*i;o[0]=t[u]-b[0],o[1]=t[u+1]-b[1],o[2]=t[u+2]-b[2],M(n,o,A),f[0]=Math.max(f[0],Math.abs(n[0])),f[1]=Math.max(f[1],Math.abs(n[1])),f[2]=Math.max(f[2],Math.abs(n[2])),s[u++]=o[0],s[u++]=o[1],s[u]=o[2]}return e.halfSize=f,s}_applyElevationOffsetInPlace(t,a,e){if(e!==0)for(let r=0;r<a;r++)t[3*r+2]+=e}}const A=g();function q(){return new _}export{q as default};
